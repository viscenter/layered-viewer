var defaultImageSetJSONFile;var defaultPageIndex;var defaultprimaryLayerIndex;var defaultSecondaryLayerIndex;if(window.location.hostname=="infoforest.vis.uky.edu"){defaultImageSetJSONFile="data/chad.json";defaultPageIndex=223;defaultPrimaryLayerIndex=4;defaultSecondaryLayerIndex=2}else{defaultImageSetJSONFile="data/test/test.json";defaultPageIndex=0;defaultPrimaryLayerIndex=0;defaultSecondaryLayerIndex=1}var OSDprefixURL="external/openseadragon/images/";var showNav=true;var showFull=false;var showScale=true;var scaleMinWidth="75px";var minZoom=.15;var maxZoom=2;var animationTime=0;var imageSetJSONFile=defaultImageSetJSONFile;var pageIndex=defaultPageIndex;var primaryLayerIndex=defaultPrimaryLayerIndex;var secondaryLayerIndex=defaultSecondaryLayerIndex;var movingFlashlight=false;var whichFlashlight=null;var flashlightIndicatorSize=5;var cursor={clipSize:500,isCircle:true};var json=$.ajax({url:imageSetJSONFile,async:false,dataType:"json"}).responseText;var pages=$.parseJSON(json)["pages"];var numPages=pages.length;var numLayers=pages[pageIndex]["layers"].length;function pageNames(){array=pages.map(function(e){return e.name});return array}var primary=OpenSeadragon({id:"primary",prefixUrl:OSDprefixURL,tileSources:pages[pageIndex]["layers"][primaryLayerIndex]["dzi"],showNavigator:showNav,navigatorID:"navigator-wrapper",animationTime:animationTime,minZoomLevel:minZoom,maxZoomLevel:maxZoom,showFullPageControl:false,showNavigationControl:false,zoomPerScroll:1.1});var secondary=OpenSeadragon({id:"secondary",prefixUrl:OSDprefixURL,tileSources:pages[pageIndex]["layers"][secondaryLayerIndex]["dzi"],showNavigator:false,animationTime:animationTime,minZoomLevel:minZoom,maxZoomLevel:maxZoom,showFullPageControl:false,showNavigationControl:false});if(showScale){primary.scalebar({type:OpenSeadragon.ScalebarType.MAP,minWidth:scaleMinWidth,pixelsPerMeter:pages[pageIndex]["layers"][primaryLayerIndex]["pixelsPerMeter"],location:OpenSeadragon.ScalebarLocation.BOTTOM_LEFT,xOffset:5,yOffset:10,stayInsideImage:true,color:"rgba(255, 255, 255, .75)",fontColor:"rgba(255, 255, 255, .75)",fontSize:"small",barThickness:2})}primary.addHandler("pan",function(e){if(primary&&secondary){if(secondary.viewport)secondary.viewport.panTo(primary.viewport.getCenter(false))}invalidate()});primary.addHandler("zoom",function(e){if(primary&&secondary){if(secondary.viewport){secondary.viewport.panTo(primary.viewport.getCenter(false));secondary.viewport.zoomTo(primary.viewport.getZoom(false))}}invalidate()});primary.addViewerInputHook({hooks:[{tracker:"viewer",handler:"scrollHandler",hookHandler:onViewerScroll},{tracker:"viewer",handler:"pressHandler",hookHandler:onViewerPress},{tracker:"viewer",handler:"releaseHandler",hookHandler:onViewerRelease},{tracker:"viewer",handler:"dragHandler",hookHandler:onViewerDrag}]});updateSearchBar();function resetView(){primary.viewport.goHome();secondary.viewport.goHome()}function zoomOut(){primary.viewport.zoomBy(.8)}function zoomIn(){primary.viewport.zoomBy(1.2)}function prevPage(){if(pageIndex!==0){pageIndex=(pageIndex-1+numPages)%numPages}else{pageIndex=numPages-1}updatePage()}function nextPage(){if(pageIndex!==numPages-1){pageIndex=(pageIndex+1)%numPages}else{pageIndex=0}updatePage()}function gotoPage(e){pageIndex=e;updatePage()}var pc=primary.canvas.children[0];if(!pc){console.log("Browser must support canvas for client to function.");console.log("Try the latest versions of Firefox or Chromium.");exit(0)}var ctx=pc.getContext("2d");setInterval(validate,1);isValid=false;function invalidate(){isValid=false}function validate(){if(isValid==false){primary.forceRedraw();isValid=true}}primary.addHandler("tile-drawn",drawFlashlights);var flashlights=[];function Flashlight(){this.x=0;this.y=0;this.clipSize=10;this.fill="white"}Flashlight.prototype.canvasPosition=function(){var e=primary.world.getItemAt(0);var a=primary.viewport.getCenter();var t=e.getBounds();var i=e.viewport.getZoom();var r=new OpenSeadragon.Point(this.x,this.y);r.x=r.x*t.width;r.y=r.y*t.height;var o=r.minus(a);o=o.times(i);o=o.times(pc.width,pc.height);var n=new OpenSeadragon.Point(pc.width/2,pc.height/2);return n.plus(o)};function addFlashlight(e,a,t){var i=new Flashlight;i.x=e;i.y=a;i.clipSize=t;flashlights.push(i);invalidate()}function drawIndicator(e,a,t,i){var r=flashlightIndicatorSize;if(i)r=flashlightIndicatorSize+flashlightIndicatorSize*.15;t.beginPath();t.arc(e.canvasPosition().x,e.canvasPosition().y,r,0,2*Math.PI,false);t.shadowOffsetX=1.5;t.shadowOffsetY=1.5;t.shadowBlur=7;t.shadowColor="black";t.fillStyle=a;t.fill();t.closePath();resetContext(t)}function resetContext(e){e.globalAlpha=1;e.shadowOffsetX=0;e.shadowOffsetY=0;e.shadowBlur=0}function drawFlashlights(){for(var e=0;e<flashlights.length;e++){if(cursor.isCircle){cutCircle(flashlights[e].canvasPosition().x,flashlights[e].canvasPosition().y,flashlights[e].clipSize/2)}else{cutSquare(flashlights[e].canvasPosition().x,flashlights[e].canvasPosition().y,flashlights[e].clipSize)}var a=false;if(e==whichFlashlight)a=true;drawIndicator(flashlights[e],flashlights[e].fill,ctx,a)}}function cutCircle(e,a,t){t=t*primary.viewport.getZoom();ctx.save();ctx.globalCompositeOperation="destination-out";ctx.beginPath();ctx.arc(e,a,t,0,2*Math.PI,false);ctx.fill();ctx.restore()}function cutSquare(e,a,t){t=t*primary.viewport.getZoom();ctx.clearRect(e-t/2,a-t/2,t,t)}var ghostcanvas;var ghostctx;function makeGhostCanvas(){ghostcanvas=document.createElement("canvas");ghostcanvas.width=pc.width;ghostcanvas.height=pc.height;ghostctx=ghostcanvas.getContext("2d")}function clearGhostCanvas(){ghostctx.clearRect(0,0,ghostcanvas.width,ghostcanvas.height)}function getIndicatorClicked(e){clearGhostCanvas();for(var a=0;a<flashlights.length;a++){drawIndicator(flashlights[a],"black",ghostctx);var t=ghostctx.getImageData(e.x,e.y,1,1);if(t.data[3]>0){whichFlashlight=a;return true}clearGhostCanvas()}whichFlashlight=null;return false}var updateDelay=50;function updatePrimaryImage(){var e=primary.viewport.getZoom(false);var a=primary.viewport.getCenter(false);primary.open(pages[pageIndex]["layers"][primaryLayerIndex]["dzi"]);setTimeout(function(){primary.viewport.zoomTo(e);primary.viewport.panTo(a)},updateDelay)}function updateSecondaryImage(){var e=secondary.viewport.getZoom(false);var a=primary.viewport.getCenter(false);secondary.open(pages[pageIndex]["layers"][secondaryLayerIndex]["dzi"]);setTimeout(function(){secondary.viewport.zoomTo(e);secondary.viewport.panTo(a)},updateDelay)}function updateSearchBar(){pageID.value=pages[pageIndex].name}function updatePage(){numLayers=pages[pageIndex]["layers"].length;primaryLayerIndex=Math.min(primaryLayerIndex,numLayers-1);secondaryLayerIndex=Math.min(secondaryLayerIndex,numLayers-1);updatePrimaryImage();updateSecondaryImage();updateSearchBar();fillSlider();sly.activate(primaryLayerIndex);updateSecondaryCard()}function onViewerScroll(e){if(e.shift){var a=15;var t=primary.world.getItemAt(0).getContentSize().y;e.preventDefaultAction=true;var i=e.originalEvent.wheelDelta/5;var r=flashlights[0].clipSize+i;if(r<a){flashlights[0].clipSize=a}else if(r>t){flashlights[0].clipSize=t}else{flashlights[0].clipSize=r}invalidate()}}function onViewerPress(e){if(getIndicatorClicked(e.position)){e.preventDefaultAction=true;e.stopBubbling=true;movingFlashlight=true}invalidate()}function onViewerDrag(e){if(movingFlashlight){e.preventDefaultAction=true;e.stopBubbling=true;var a=new OpenSeadragon.Point(e.delta.x,e.delta.y);var t=a.divide(pc.width,pc.height);var i=primary.viewport.getZoom();t=t.divide(i);var r=primary.world.getItemAt(0).getBounds();t.x=t.x/r.width;t.y=t.y/r.height;flashlights[whichFlashlight].x+=t.x;flashlights[whichFlashlight].y+=t.y;invalidate()}}function onViewerRelease(e){if(movingFlashlight){e.preventDefaultAction=true;e.stopBubbling=true;whichFlashlight=null;movingFlashlight=false}invalidate()}var waitForFinalEvent=function(){var e={};return function(a,t,i){if(!i){i="Don't call this twice without a uniqueId"}if(e[i]){clearTimeout(e[i])}e[i]=setTimeout(a,t)}}();$(window).resize(function(e){waitForFinalEvent(function(){secondary.viewport.panTo(primary.viewport.getCenter(false));secondary.viewport.zoomTo(primary.viewport.getZoom(false));ghostcanvas.width=pc.width;ghostcanvas.height=pc.height;ghostctx=ghostcanvas.getContext("2d");invalidate()},50,"resize")});var shiftDown=false;$(document).keyup(function(e){switch(e.which){default:return}});$(document).keydown(function(e){switch(e.which){case 67:cursor.isCircle=!cursor.isCircle;invalidate();break;case 73:secondaryLayerIndex=(secondaryLayerIndex+1)%numLayers;updateSecondaryImage();updateSecondaryCard();break;case 74:sly.activate((primaryLayerIndex-1+numLayers)%numLayers);break;case 75:secondaryLayerIndex=(secondaryLayerIndex-1+numLayers)%numLayers;updateSecondaryImage();updateSecondaryCard();break;case 76:sly.activate((primaryLayerIndex+1)%numLayers);break;case 77:nextPage();break;case 78:prevPage();break;case 79:break;case 85:break;default:return}});var sly=new Sly("#frame",{horizontal:1,itemNav:"forceCentered",smart:1,activateOn:"click",mouseDragging:1,touchDragging:1,releaseSwing:1,startAt:primaryLayerIndex,scrollBy:1,speed:300,elasticBounds:1,easing:"easeOutExpo",dragHandle:1,dynamicHandle:1,clickBar:1});sly.on("active",function(e,a){if(primaryLayerIndex!==a){primaryLayerIndex=a;updatePrimaryImage()}});sly.init();$(window).resize(function(e){sly.reload()});function fillSlider(){cards=sly.items.length;for(i=0;i<cards;i++){sly.remove(0)}for(i=0;i<numLayers;i++){version=pages[pageIndex]["layers"][i]["version"];var e="";e='<li id="'+i+'"><paper-material class="layer-card" elevation="1"><span class="vertically-aligned">'+version+"</span></paper-material></li>";sly.add(e)}}function fillPageSelector(){var e="";for(id=0;id<pageNames().length;id++){e='<li class="page-item" id="'+id+'" onclick="gotoPage('+id+')">'+pageNames()[id]+"</li>";$("#page-selector").append(e)}}function updateSecondaryCard(){var e=$("#slidee").find(".second-active");e.removeClass("second-active");e.find("span").find(".circle.indicator").remove();var a='<div class="circle indicator"></div>';var t=$("#slidee").find("#"+secondaryLayerIndex);t.addClass("second-active");t.find("span").prepend(a)}function toggleLayerSelector(){if($("#layer-selector").css("display")=="none"){$("#layer-selector-toggle").animate({"margin-bottom":"-15px"},{step:function(e,a){var t=-((e+15)*180)/25;$(this).find("iron-icon").css("-ms-transform","rotate("+t+"deg)");$(this).find("iron-icon").css("-webkit-transform","rotate("+t+"deg)");$(this).find("iron-icon").css("transform","rotate("+t+"deg)")}},400)}else{$("#layer-selector-toggle").animate({"margin-bottom":"10px"},{step:function(e,a){var t=(e+15)*180/25;$(this).find("iron-icon").css("-ms-transform","rotate("+t+"deg)");$(this).find("iron-icon").css("-webkit-transform","rotate("+t+"deg)");$(this).find("iron-icon").css("transform","rotate("+t+"deg)")}},400)}$("#layer-selector").slideToggle(400);sly.reload()}$("#layer-selector-fab").mouseenter(function(){$("#layer-selector-label").animate({opacity:"1.0"},"fast")});$("#layer-selector-fab").mouseleave(function(){$("#layer-selector-label").animate({opacity:"0.0"},"fast")});$("#help-button").mouseenter(function(){$("#help-label").animate({opacity:"1.0"},"fast")});$("#help-button").mouseleave(function(){$("#help-label").animate({opacity:"0.0"},"fast")});$("#help-button").click(function(){if(Shepherd.activeTour==null){primary.setMouseNavEnabled(false);$(".navigator").hide();var e=document.getElementById("help-dialog");e.open()}});function onHelpConfirm(){startTour()}function onHelpClose(){primary.setMouseNavEnabled(true);$(".navigator").show()}$("#pageID").focusin(function(){$("#page-selector").slideDown(200)});$("#pageID").focusout(function(){$("#page-selector").delay(50).slideUp(200)});$(window).load(function(){fillSlider();fillPageSelector();Polymer.updateStyles();sly.activate(primaryLayerIndex);updateSecondaryCard();makeGhostCanvas();addFlashlight(.5,.5,cursor.clipSize);sly.reload();$("#help-button").click()});var tour=new Shepherd.Tour({defaults:{classes:"shepherd-theme-arrows",scrollTo:false}});tour.addStep("welcome",{text:"This image viewer allows you to view and compare the pages of the Chad Gospels across time."});backgroundText="The background image is showing us the page as it existed in ";tour.addStep("background",{text:backgroundText,attachTo:"#primary left",tetherOptions:{attachment:"middle left",targetAttachment:"middle center",offset:"0 0"}});var flashlightText="The flashlight reveals the page as it existed at some other point in time. Right now, it's showing us what this page looked like in ";tour.addStep("flashlight",{text:flashlightText,attachTo:"#primary left",tetherOptions:{attachment:"middle left",targetAttachment:"middle center",offset:"0 0"}});tour.addStep("indicator",{text:"Move the flashlight by clicking and dragging this handle.",attachTo:"#primary left",tetherOptions:{attachment:"middle left",targetAttachment:"middle center",offset:"0 -"+(flashlightIndicatorSize+10)},when:{show:startDemoRotation,hide:resetDemoRotation}});tour.addStep("resize",{text:"Resize the flashlight by holding Shift and scrolling the mouse wheel.",attachTo:"#primary left",tetherOptions:{attachment:"middle left",targetAttachment:"middle center",offset:"0 -"+(flashlightIndicatorSize+10)},when:{show:startDemoScroll,hide:resetDemoScroll}});tour.addStep("selectedPrimary",{text:"The current background image is indicated in blue.",attachTo:".active left",tetherOptions:{attachment:"bottom center",targetAttachment:"top center",offset:"-5 0"}});var idBeforeActive;tour.addStep("changePrimary",{text:"To change the background image, select another image from this list. Alternatively, use the J/L keys on the keyboard to cycle through the list.",attachTo:".active left",tetherOptions:{attachment:"bottom center",targetAttachment:"top center",offset:"-5 0"}});tour.addStep("selectedFlashlight",{text:"The current flashlight image is indicated with a dot.",attachTo:".second-active left",tetherOptions:{attachment:"bottom center",targetAttachment:"top center",offset:"-5 0"}});tour.addStep("changeFlashlight",{text:"To change the flashlight image, use the I/K keys on the keyboard to cycle through the list.",attachTo:".second-active left",tetherOptions:{attachment:"bottom center",targetAttachment:"top center",offset:"-5 0"}});tour.addStep("changePage",{text:"To see other pages of the Chad Gospels, select them from this dropdown.",attachTo:"#page-selector right",beforeShowPromise:function(){$("#page-selector").show()},tetherOptions:{attachment:"middle right",targetAttachment:"middle left",offset:"0 5"},when:{hide:function(){$("#page-selector").slideUp(200)}}});tour.addStep("help",{text:"To access this tour again, click the help button.",attachTo:"#help-button right",tetherOptions:{attachment:"top left",targetAttachment:"top right",offset:"10 -5"},buttons:[{text:"Get Started",action:tour.complete}]});function startTour(){primary.setMouseNavEnabled(false);$(".navigator").hide();resetView();var e=primary.viewport.contentSize.x*primary.viewport.viewportToImageZoom(primary.viewport.getZoom())/2;tour.getById("background").options.tetherOptions.offset="0 -"+e+"px";tour.getById("background").options.text=backgroundText+pages[pageIndex]["layers"][primaryLayerIndex]["version"]+".";var a=flashlights[0].clipSize*primary.viewport.getZoom()/2;tour.getById("flashlight").options.tetherOptions.offset="0 -"+a+"px";tour.getById("flashlight").options.text=flashlightText+pages[pageIndex]["layers"][secondaryLayerIndex]["version"]+".";elemBeforeActive=$("li.active").prev();if(elemBeforeActive.length===0){elemBeforeActive=$("li.active")[0]}else{elemBeforeActive=elemBeforeActive[0]}tour.getById("changePrimary").options.attachTo={element:elemBeforeActive,on:"left"};if($("#layer-selector").css("display")=="none")toggleLayerSelector();tour.start()}tour.on("complete",function(){_.each(tour.steps,function(e){e.destroy()});primary.setMouseNavEnabled(true);$(".navigator").show()});var original={};var modulator;var angle=0;var theta=2;var demoLight=0;function startDemoRotation(){var e={delta:{x:0,y:0}};movingFlashlight=true;whichFlashlight=demoLight;original.x=flashlights[demoLight].x;original.y=flashlights[demoLight].y;flashlights[demoLight].x+=10/pc.width/primary.viewport.getZoom();flashlights[demoLight].y-=10/pc.height/primary.viewport.getZoom();modulator=setInterval(function(){var a=Math.cos(toRadian(angle));var t=Math.sin(toRadian(angle));e.delta.x=a;e.delta.y=t;onViewerDrag(e);angle+=theta+.5},1)}function resetDemoRotation(){clearInterval(modulator);angle=0;flashlights[demoLight].x=original.x;flashlights[demoLight].y=original.y;original={};movingFlashlight=false;whichFlashlight=null;invalidate()}function startDemoScroll(){var e={originalEvent:{wheelDelta:0}};shiftDown=true;whichFlashlight=demoLight;original.clipSize=flashlights[demoLight].clipSize;modulator=setInterval(function(){e.originalEvent.wheelDelta=Math.sin(toRadian(angle))*50;onViewerScroll(e);angle+=theta},1)}function resetDemoScroll(){clearInterval(modulator);angle=0;flashlights[demoLight].clipSize=original.clipSize;original={};shiftDown=false;whichFlashlight=null;invalidate()}function toRadian(e){return e*Math.PI/180}function toDegree(e){return e*180/Math.PI}function toggleMenu(){var e=document.getElementById("paperDrawerPanel");e.togglePanel()}
//# sourceMappingURL=layered-viewer.min.js.map